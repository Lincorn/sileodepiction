name: Update Sileo Depictions

on:
  push:
    branches:
      - main
    paths:
      - 'com.**.**/js.json'  # 监听所有 com.xxx.xx/ 下的 JSON 文件的变化

jobs:
  update_version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3  # 更新为最新版本

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Get version from JSON files
        id: get_versions
        run: |
          VERSION_LIST=""
          for file in com.**.**/js.json; do
            if [ -f "$file" ]; then
              # 获取版本号，这里假设为 minVersion
              VERSION=$(jq -r '.minVersion' "$file")  
              FILENAME=$(basename "$file" .json)
              VERSION_LIST="$VERSION_LIST$FILENAME: $VERSION\n"
            fi
          done
          echo "VERSIONS=${VERSION_LIST}" >> $GITHUB_ENV

      - name: Update main.yaml with new versions
        run: |
          if [ -f .github/workflows/main.yaml ]; then
            while IFS= read -r line; do
              FILENAME=$(echo "$line" | cut -d ':' -f 1)
              VERSION=$(echo "$line" | cut -d ':' -f 2 | xargs)
              sed -i "s/${FILENAME} version: .*/${FILENAME} version: ${VERSION}/" .github/workflows/main.yaml
            done <<< "${{ env.VERSIONS }}"
          else
            echo "Error: main.yaml file does not exist."
            exit 1
          fi

      - name: Commit changes
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add .github/workflows/main.yaml
          git commit -m "Update versions based on JSON files" || echo "No changes to commit"
          git push
