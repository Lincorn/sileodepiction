name: Update Sileo Depictions

on:
  push:
    branches:
      - main
    paths:
      - 'com.*/**/*.json'  # 监听所有 com.xxx.xx/ 下的 JSON 文件的变化

jobs:
  update_version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Get version from JSON files
        id: get_versions
        run: |
          VERSION_LIST=""
          for file in com.*/**/*.json; do
            if [ -f "$file" ]; then
              VERSION=$(jq -r '.tabs[0].views[7].text' "$file")  # 假设版本号在此路径
              FILENAME=$(basename "$file" .json)
              VERSION_LIST="$VERSION_LIST$FILENAME: $VERSION\n"
            fi
          done
          echo "VERSIONS=${VERSION_LIST}" >> $GITHUB_ENV

      - name: Update main.yaml with new versions
        run: |
          while IFS= read -r line; do
            FILENAME=$(echo "$line" | cut -d ':' -f 1)
            VERSION=$(echo "$line" | cut -d ':' -f 2 | xargs)
            sed -i "s/${FILENAME} version: .*/${FILENAME} version: ${VERSION}/" .github/workflows/main.yaml
          done <<< "${{ env.VERSIONS }}"

      - name: Commit changes
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add .github/workflows/main.yaml
          git commit -m "Update versions based on JSON files"
          git push
